services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - django
    restart: always

  django:
    build: .
    command: gunicorn chat_bot_mac.wsgi:application --bind 0.0.0.0:8000 --workers 2
    volumes:
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media:ro
      - ./config:/app/config:ro
      - ./staticfiles:/app/staticfiles
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MASTER_NAME=${MASTER_NAME}
      - USE_REDIS=False
      - PRODAMUS_MERCHANT_URL=${PRODAMUS_MERCHANT_URL}
      - PRODAMUS_SECRET_KEY=${PRODAMUS_SECRET_KEY}
      - PRODAMUS_TEST_MODE=${PRODAMUS_TEST_MODE:-False}
      - BASE_URL=${BASE_URL}
    restart: always

  bot:
    build: .
    command: python manage.py runbot
    network_mode: host
    volumes:
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media:ro
      - ./config:/app/config:ro
    environment:
      - DEBUG=${DEBUG:-False}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MASTER_NAME=${MASTER_NAME}
      - USE_REDIS=${USE_REDIS:-True}
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    restart: always
